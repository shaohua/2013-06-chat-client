<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chat with JSON!</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="vendor/jquery/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="js/setup.js"></script>
  </head>
  <body>

    <div id="main">
      <h1>Chat with JSON!</h1>
      <div class='input'>
        <form>
          <label>Msg: </label>
          <input type="text" name="msg"></input>
          <button type="submit">Tweet</button>
        </form>
      </div>
    </div>
    <script>


    // var rooms = [];
    // rooms.addRoom = function(room_name){
    // expect room_name to be string which would be part of the url
    // expect room to be at: https://api.parse.com/1/classes/room_name?order=-createdAt
    //   var room = new Room(room_name);
    //  rooms.push(room);
    // };

    // rooms.removeRoom = function(){
    // remove from the array
    // };

    // rooms.displayRooms = function(room_name){
    // for each room, call room.display()
    // };

    var formHandler = function(event){
      event.preventDefault(); //prevent from refresh on submit
      var data = $('form').serializeArray();

      var msg_text = data[0].value;

      user.user_name = user.user_name || 'marcus_the_god'; //default
      var msg = {username: user.user_name};
      _(msg).extend({text: msg_text});

      user.newmessage(msg);

      //fetch
      room.fetch_msg();
    };


    $("form").on('submit', formHandler);

    var peopleHandler = function(event){
      event.preventDefault();
      var buddyName = event.target.textContent;
      //if buddyName is not a friend
      //add to buddy list
      //add class=buddy to its parent element
      if (_(user.buddyList).indexOf(buddyName) === -1) {
        user.buddyList.push(buddyName);
        $('.people').each(function(index){
          var flag = _(user.buddyList).contains($(this).text());
          if (flag) {
            $(this).parent().addClass("buddy");
          }
        });
      //if buddyName is a friend but we clicked on it
      //delete from buddy list
      //remove class=buddy from its parent element
      } else {
        user.buddyList.splice(_(user.buddyList).indexOf(buddyName), 1);
        $('.people').each(function(index){
          if ( $(this).text() === buddyName ) {
            $(this).parent().removeClass("buddy");
          }
        });
      }
    };



    var Room = function(room_name) {
      this.room_name = room_name;
    };

    Room.prototype.display = function(){
      $('body').append('<div class="room1"></div>');
      $('.room1').append('<h3 class="room_name">' +
          this.room_name + '</h3>');
    };

    Room.prototype.fetch_msg = function(){
      var that = this;
      $.ajax({
        url:'https://api.parse.com/1/classes/messages?order=-createdAt'
      }).done(function(data){

        var parse_data = function(data){
          var results = data.results;
          var $container = $('<div class="container"></div>');
          for(var i=0; i<results.length; i++){
            var templateString = "<div> \
                <span class='people'><%= username %></span>  \
                <span><%= createdAt %></span> \
                <span><%= message %></span> \
              </div><br>";
            var messageData = {
              username:  _.escape( results[i].username ),
              createdAt: _.escape( results[i].createdAt ),
              message: _.escape(results[i].text)
            };
            $container.append(_.template(templateString, messageData));
          }

          //asyncally refresh msg list
          if ($('.container').length === 0) {
            $('.room1').append($container);
              //rebind events everytime page reloads
              $('.people').on('click', peopleHandler);
          } else {
            $('.container').replaceWith($container);
              //rebind events everytime page reloads
              $('.people').on('click', peopleHandler);
          }
        };

        parse_data(data);

    });

      //call it every 100 ms
      // setTimeout(function(){
      //   that.fetch_msg();
      // }, 100);

    };

    var room1 = new Room('messages');

    room1.display();

    var user = {
      user_name: window.location.search.split('?username=')[1],
      newmessage: function(message){
        //expect message as a obj with key-value pairs
        var msg = JSON.stringify(message);

        var request = $.ajax({
          url:'https://api.parse.com/1/classes/messages',
          type: "POST",
          data: msg,
          contentType: 'application/json'
        });

        request.done(function(message){
          console.log('done', message);
        });

        request.fail(function(jqXHR, textStatus){
          console.log('request failed' + textStatus + jqXHR.responseText);
        });
      },
      buddyList: []
    };

    room1.fetch_msg();

    </script>

  </body>
</html>
